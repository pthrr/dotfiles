#!/usr/bin/env bash
set -euo pipefail

REDIS_HOST="${SCCACHE_REDIS_HOST:-'nwv-srv'}"
REDIS_PORT="${SCCACHE_REDIS_PORT:-6380}"

if timeout 5 bash -c "</dev/tcp/${REDIS_HOST}/${REDIS_PORT}" 2>/dev/null; then
    echo "DEBUG: Using remote cache" >&2
    SCCACHE_REDIS_ENDPOINT="redis://${REDIS_HOST}:${REDIS_PORT}" sccache "$@"
else
    echo "DEBUG: Using local cache" >&2
    SCCACHE_DIR="$HOME/.cache/sccache" SCCACHE_CACHE_SIZE="10G" sccache "$@"
fi
