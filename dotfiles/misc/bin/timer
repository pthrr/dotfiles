#!/usr/bin/env bash
#
# timer - Simple timer for Waybar
#
# Usage: timer [COMMAND]
#
# Commands:
#   start    Start/resume timer
#   reset    Reset timer to zero
#   status   Show current time (default)
#   help     Show this help message

set -euo pipefail

TIMER_FILE="${XDG_CACHE_HOME:-${HOME}/.cache}/timer_start"
[ -d "$(dirname "$TIMER_FILE")" ] || TIMER_FILE="${TMPDIR:-/tmp}/timer_start"

cleanup() {
    # Cleanup function for trap
    :
}

trap cleanup EXIT INT TERM

show_help() {
    cat << EOF
Usage: timer [COMMAND]

Simple timer for Waybar

Commands:
  start    Start/resume timer
  reset    Reset timer to zero
  status   Show current time (default)
  help     Show this help message

Examples:
  timer start     # Start the timer
  timer           # Show current time
  timer reset     # Reset to 00:00:00
EOF
}

cmd_start() {
    if [ ! -f "$TIMER_FILE" ]; then
        date +%s > "$TIMER_FILE"
        echo "Timer started"
    else
        echo "Timer already running"
    fi
}

cmd_reset() {
    rm -f "$TIMER_FILE"
    echo "Timer reset"
}

cmd_status() {
    if [ -f "$TIMER_FILE" ]; then
        local start_time current_time elapsed hours minutes seconds
        start_time=$(cat "$TIMER_FILE")
        current_time=$(date +%s)
        elapsed=$((current_time - start_time))

        hours=$((elapsed / 3600))
        minutes=$(((elapsed % 3600) / 60))
        seconds=$((elapsed % 60))

        printf "%02d:%02d:%02d" $hours $minutes $seconds
    else
        echo "00:00:00"
    fi
}

main() {
    case "${1:-status}" in
        start)
            cmd_start
            ;;
        reset)
            cmd_reset
            ;;
        status)
            cmd_status
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Unknown command: $1" >&2
            show_help
            exit 1
            ;;
    esac
}

main "$@"
