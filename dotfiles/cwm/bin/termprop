#!/usr/bin/env bash
#set -eu -o pipefail

BAR_FIFO=/tmp/bar_fifo
_NET_NUMBER_OF_DESKTOPS=10

if [ ! -e "${BAR_FIFO}" ] ; then
    exit 1
fi

xprop -spy -root -notype \
    -f _NET_ACTIVE_WINDOW '32x' '=$0\n' \
    -f _NET_CURRENT_DESKTOP '32i' '=$0\n' \
    -f _NET_CLIENT_LIST '32x' '=$0+\n' \
    _NET_ACTIVE_WINDOW _NET_CURRENT_DESKTOP _NET_CLIENT_LIST | \
    while read LINE ; do
        case ${LINE} in
            _NET_CURRENT_DESKTOP*)
                _NET_CURRENT_DESKTOP=${LINE//*=/}
                ;;
            _NET_ACTIVE_WINDOW*)
                ;;
            _NET_CLIENT_LIST*)
                client_desktop_list=""
                _NET_CLIENT_LIST=${LINE//*=/}

                for client in ${_NET_CLIENT_LIST//,/} ; do
                    _NET_WM_DESKTOP=$(xprop -f _NET_WM_DESKTOP '32i' '=$0' -id ${client} -notype _NET_WM_DESKTOP)

                    if [[ ${client_desktop_list} != *${_NET_WM_DESKTOP}* ]] ; then
                        client_desktop_list="${client_desktop_list} ${_NET_WM_DESKTOP//*=/}"
                    fi
                done
                ;;
        esac

        output='PROP|'

        for (( desktop=1; desktop<${_NET_NUMBER_OF_DESKTOPS}; desktop++ )) ; do
            if (( desktop == _NET_CURRENT_DESKTOP )) ; then
                output="${output} [${desktop}]"
            else
                if [[ ${client_desktop_list} =~ ${desktop} ]] ; then
                    output="${output} *${desktop} "
                else
                    output="${output}  ${desktop} "
                fi
            fi
        done

        echo -e "${output}"
    done > ${BAR_FIFO}
